<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SFU Course Pre-requisites/Co-requisites Visualizations</title>
  <style>
    :root {
  --bg: transparent;                 /* Background */
  --panel: transparent;            /* Panel/sidebar */
  --text: #222;                /* Main text */
  --muted: #888;               /* Muted/secondary text */
  --accent: #0074d9;           /* Accent color (blue) */
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif
}
header{
  padding:20px 24px;
  border-bottom:1px solid #e2e2e2;
  background:var(--panel);
  position:sticky;
  top:0;
  z-index:10
}
.wrap{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap:0
}
.sidebar{
  height:calc(100dvh - 72px);
  overflow:auto;
  border-right:1px solid #e2e2e2;
  background:var(--panel)
}
.main{
  height:calc(100dvh - 72px);
  display:flex;
  flex-direction:column
}
.search{
  display:flex;
  gap:8px;
  padding:12px
}
.search input,
.search select{
  width:100%;
  padding:10px 12px;
  border:1px solid #ddd;
  border-radius:10px;
  background:var(--bg);
  color:var(--text)
}
.count{
  padding:0 12px 12px;
  color:var(--muted);
  font-size:13px
}
.list{
  display:grid;
  gap:8px;
  padding:0 12px 16px
}
.item{
  border:1px solid #e6e6e6;
  border-radius:12px;
  padding:12px;
  background:var(--bg);
  cursor:pointer;
  transition:transform .06s ease
}
.item:hover{
  transform:translateY(-1px);
  border-color:var(--accent)
}
.code{
  font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  color:var(--accent)
}
iframe{
  flex:1;
  border:0;
  background:var(--panel)
}
.empty{
  margin:auto;
  color:var(--muted)
}
@media (max-width: 980px){
  .wrap{grid-template-columns:1fr}
  .sidebar{height:auto}
  .main{height:auto}
  iframe{height:70vh}
}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:20px">SFU Course Pre-requisites/Co-requisites Visualizations</h1>
    <div style="color:var(--muted);font-size:13px">Browse, search, and open any course visualization for a department.</div>
  </header>

  <div class="wrap">
    <aside class="sidebar">
      <div class="search">
        <select id="dept">
          <option value="">All Departments</option>
        </select>
      </div>
    </aside>

    <main class="main">
      <iframe id="viewer" title="Course Visualization"></iframe>
      <div id="empty" class="empty" hidden>
        <p>Select a department from the left to load its visualization.</p>
      </div>
    </main>
  </div>

  <script>
    const ROOT = new URL('.', window.location.href); // directory of index.html
    const state = { all: [], filtered: [], selected: null };
    const els = {
      dept: document.getElementById('dept'),
      viewer: document.getElementById('viewer'),
      empty: document.getElementById('empty')
    };

    async function boot(){
      try{
        const manifestURL = new URL('manifest.json', ROOT);
        const res = await fetch('manifest.json', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} for ${manifestURL.href}`);
        state.all = await res.json();
        hydrateDeptFilter(state.all);
       //deep links
        const params = new URLSearchParams(location.search);
        const fileParam = params.get('file');
        const deptParam = params.get('dept');
         if (fileParam) {
          const hit = state.all.find(x => x.file.toLowerCase() === fileParam.toLowerCase());
          if (hit) { select(hit); els.dept.value = hit.dept; }
        } else if (deptParam) {
          els.dept.value = deptParam.toUpperCase();
          selectByDept(els.dept.value);
        } else {
          selectDefault(); // sfu.html if present;
        }
        // Change handler: load visualization immediately on department change
        els.dept.addEventListener('change', () => selectByDept(els.dept.value));
      }catch(err){
        console.error(err);
        els.list.innerHTML = `<div class="item">⚠️ Unable to load manifest.json. Make sure it exists at the repo root.</div>`;
      }
    } 
    
   // Pick a visualization for a department
    function selectByDept(dept) {
      if (!dept) {                  // All Departments → default page
        selectDefault();
        return;
      }
      const pool = state.all.filter(x => x.dept === dept);
      if (pool.length === 0) {
        console.warn('No entries for dept:', dept);
        selectDefault();
        return;
      }
      // Prefer a file named exactly "<DEPT>.html" if present; else first match
      const preferred = pool.find(x => x.file.toLowerCase() === `${dept.toLowerCase()}.html`) || pool[0];
      select(preferred);
    }

    function selectDefault() {
      const sfu = state.all.find(x => x.file.toLowerCase() === 'sfu.html');
      if (sfu) select(sfu);
    }
    
     function hydrateDeptFilter(items) {
      // Collect unique dept codes and pick a "title" from the first match
      const depts = {};
      for (const x of items) {
        if (!depts[x.dept]) {
          depts[x.dept] = x.title || x.dept; // fallback to code if title missing
        }
      }
      // Reset dropdown with "All Departments"
      els.dept.innerHTML = '<option value="">All Departments</option>';
      // Build options like "BUS — Business Administration"
      Object.keys(depts).sort().forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = `${d} — ${depts[d]}`;
        els.dept.appendChild(opt);
      });
    }
    
     function select(item) {
      state.selected = item;
      const fileURL = new URL(`Visualizations/${item.file}`, ROOT); // ← folder name must match exactly
      els.viewer.src = fileURL.href;
      els.empty.hidden = true;
      history.replaceState(null, '', `?dept=${encodeURIComponent(item.dept)}`);
    }

   boot();
  </script>
</body>
</html>
